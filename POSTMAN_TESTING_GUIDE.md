# OkPuja Payment API Testing Guide

## üìã Postman Collection Overview

This Postman collection contains comprehensive tests for all payment-related endpoints in the OkPuja backend system with PhonePe integration.

## üìÅ Collection Structure

### 1. **Authentication**
- Login (automatically saves tokens)
- Refresh Token

### 2. **Payment Management**
- List Payments (with filters)
- Create Payment (initiates PhonePe checkout)
- Get Payment Details
- Check Payment Status

### 3. **Refund Management**
- Initiate Refund

### 4. **Webhook Endpoints**
- PhonePe Webhook (simulate callback)

### 5. **Admin Endpoints**
- Admin Payment Management
- Manual Payment Capture
- Payment Cancellation

### 6. **Test Data Setup**
- Create Test User
- Create Test Booking

### 7. **Error Testing**
- Invalid requests
- Unauthorized access
- Validation errors

## üöÄ Quick Setup

### 1. Import Files
1. Import `OkPuja_Payment_API.postman_collection.json` into Postman
2. Import `OkPuja_Payment_Environment.postman_environment.json` as environment
3. Select the "OkPuja Payment Environment" in Postman

### 2. Environment Configuration

#### Development Setup (Default)
```
base_url: http://localhost:8000
frontend_base_url: http://localhost:3000
```

#### Production Setup
```
base_url: https://backend.okpuja.com
frontend_base_url: https://okpuja.com
```

### 3. Authentication Setup
Update these values in your environment:
```
test_user_email: your_test_email@example.com
test_user_password: your_test_password
admin_email: admin@okpuja.com
admin_password: admin@123
```

## üß™ Testing Workflow

### Step 1: Setup Authentication
1. **Create Test User** (if needed)
   - Run "Create Test User" request
   - Or use existing user credentials

2. **Login**
   - Run "Login" request
   - Access token will be automatically saved to environment

### Step 2: Create Test Data
1. **Create Test Booking**
   - Run "Create Test Booking" request
   - Booking ID will be automatically saved

### Step 3: Test Payment Flow

#### A. Create Payment
1. Run "Create Payment" request
2. Check response for:
   - `payment_id` (saved automatically)
   - `merchant_transaction_id` (saved automatically)
   - `payment_url` (PhonePe checkout URL)

#### B. Open Payment URL
1. Copy the `payment_url` from response
2. Open in browser to test PhonePe checkout
3. Complete test payment (use test cards in UAT)

#### C. Check Payment Status
1. Run "Check Payment Status" request
2. Verify status updates

### Step 4: Test Webhook (Optional)
1. Set up `callback_auth` in environment (Base64 encoded username:password)
2. Run "PhonePe Webhook" request to simulate callback

### Step 5: Test Refund
1. Ensure payment is in SUCCESS status
2. Run "Initiate Refund" request

## üîß Environment Variables

### Required Variables
| Variable | Description | Example |
|----------|-------------|---------|
| `base_url` | Backend API URL | `http://localhost:8000` |
| `frontend_base_url` | Frontend URL | `http://localhost:3000` |
| `test_user_email` | Test user email | `test@example.com` |
| `test_user_password` | Test user password | `password123` |

### Auto-Generated Variables
| Variable | Description | Generated By |
|----------|-------------|--------------|
| `access_token` | JWT access token | Login request |
| `payment_id` | Payment ID | Create Payment request |
| `merchant_transaction_id` | PhonePe transaction ID | Create Payment request |
| `booking_id` | Booking ID | Create Booking request |

## üìù Test Scenarios

### 1. Happy Path
```
1. Login ‚Üí 2. Create Booking ‚Üí 3. Create Payment ‚Üí 4. Check Status ‚Üí 5. Refund
```

### 2. Error Scenarios
- Invalid authentication
- Invalid payment amounts
- Non-existent bookings
- Unauthorized access

### 3. Admin Scenarios
- Admin login
- Manual payment capture
- Payment cancellation

## üîç Response Validation

### Create Payment Response
```json
{
    "success": true,
    "payment_id": 1,
    "merchant_transaction_id": "MT1234567890",
    "transaction_id": "TXN1234567890",
    "amount": "100.00",
    "currency": "INR",
    "payment_url": "https://checkout.phonepe.com/...",
    "status": "PENDING"
}
```

### Payment Status Response
```json
{
    "success": true,
    "code": "STATUS_CHECKED",
    "message": "Payment status checked successfully",
    "transaction_id": "TXN1234567890",
    "merchant_transaction_id": "MT1234567890",
    "amount": "100.00",
    "currency": "INR",
    "status": "SUCCESS",
    "payment_method": "PHONEPE"
}
```

## üö® Common Issues & Solutions

### 1. Authentication Errors
**Issue**: 401 Unauthorized
**Solution**: 
- Ensure you've run the Login request first
- Check if token is saved in environment
- Token might be expired, run Refresh Token

### 2. Payment Creation Fails
**Issue**: 400 Bad Request
**Solution**:
- Ensure booking exists and belongs to authenticated user
- Check amount format (string with 2 decimal places)
- Verify PhonePe configuration in environment

### 3. Webhook Testing
**Issue**: 400 Bad Request on webhook
**Solution**:
- Set correct `callback_auth` (Base64 encoded)
- Ensure webhook endpoint is accessible
- Check PhonePe credentials

### 4. CORS Issues
**Issue**: Browser CORS errors
**Solution**:
- Ensure django-cors-headers is configured
- Add frontend URL to CORS_ALLOWED_ORIGINS

## üîí Security Testing

### Authentication Tests
- [ ] Login with valid credentials
- [ ] Login with invalid credentials
- [ ] Access protected endpoints without token
- [ ] Access with expired token
- [ ] Token refresh functionality

### Authorization Tests
- [ ] User can only access their own payments
- [ ] Admin can access all payments
- [ ] Regular user cannot access admin endpoints

### Data Validation Tests
- [ ] Invalid payment amounts
- [ ] Missing required fields
- [ ] SQL injection attempts
- [ ] XSS in input fields

## üìä Performance Testing

### Load Testing Endpoints
- `POST /api/payments/payments/` (payment creation)
- `GET /api/payments/payments/{id}/status/` (status check)
- `POST /api/payments/webhook/phonepe/` (webhook processing)

### Metrics to Monitor
- Response time
- Success rate
- Database connections
- Memory usage

## üåê Production Testing

### Before Production Deployment
1. **Update Environment**
   ```
   base_url: https://backend.okpuja.com
   frontend_base_url: https://okpuja.com
   ```

2. **Test SSL/HTTPS**
   - All requests should use HTTPS
   - No certificate warnings

3. **Test Webhook**
   - Webhook URL accessible from PhonePe
   - Proper authentication configured

4. **Performance Testing**
   - Load test critical endpoints
   - Monitor response times

### Production Checklist
- [ ] SSL certificates valid
- [ ] PhonePe production credentials configured
- [ ] Webhook URL updated in PhonePe dashboard
- [ ] Database backups enabled
- [ ] Monitoring and alerting configured

## üìû Support

For issues with:
- **API Endpoints**: Check Django logs
- **PhonePe Integration**: Refer to PhonePe documentation
- **Authentication**: Verify JWT configuration
- **Database**: Check connection and migrations

## üìö Additional Resources

- [PhonePe Developer Documentation](https://developer.phonepe.com/)
- [Django REST Framework Documentation](https://www.django-rest-framework.org/)
- [Postman Testing Guide](https://learning.postman.com/docs/writing-scripts/test-scripts/)

---

**Note**: Always test in UAT environment before production deployment.
